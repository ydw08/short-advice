<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 학습 도우미</title>
    <!-- Tailwind CSS 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter 폰트 로드 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* 기본 폰트 설정 */
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
        }
        
        /* 페이지 숨김/표시를 위한 기본 스타일 */
        .page {
            display: none; /* 모든 페이지를 기본적으로 숨김 */
        }

        /* 채팅 말풍선 스타일 */
        .chat-bubble {
            max-width: 80%;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            word-wrap: break-word;
        }
        .user-bubble {
            background-color: #dbeafe; /* blue-100 */
            color: #1e40af; /* blue-800 */
            margin-left: auto;
            border-bottom-right-radius: 0;
        }
        .ai-bubble {
            background-color: #f3f4f6; /* gray-100 */
            color: #1f2937; /* gray-800 */
            margin-right: auto;
            border-bottom-left-radius: 0;
        }
        .ai-thinking-bubble {
            background-color: #f3f4f6; /* gray-100 */
            color: #6b7280; /* gray-500 */
            font-style: italic;
            margin-right: auto;
            border-bottom-left-radius: 0;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- 모든 페이지를 감싸는 컨테이너 -->
    <div class="w-full max-w-xl">

        <!-- =======================
             1. 로그인 페이지 (시뮬레이션)
        ======================== -->
        <div id="login-page" class="page bg-white p-8 rounded-xl shadow-2xl">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">로그인 (시뮬레이션)</h2>
            <div id="login-error" class="text-red-500 text-center mb-4 hidden text-sm font-semibold"></div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-2">아이디 (이메일)</label>
                    <input type="email" id="username" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="user@example.com" autocomplete="email">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">비밀번호</label>
                    <input type="password" id="password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••••" autocomplete="current-password">
                </div>
                <button type="submit" id="login-btn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                    로그인
                </button>
                <button type="button" id="nav-to-signup" class="w-full text-sm text-center text-blue-600 hover:underline mt-4">
                    아직 계정이 없으신가요? 회원가입
                </button>
            </form>
            <p class="text-xs text-gray-500 mt-4 text-center">
                * 이메일과 비밀번호는 이 브라우저에만 저장되며, 실제 서버에 전송되지 않습니다.
            </p>
        </div>

        <!-- =======================
             1.5. 회원가입 페이지 (시뮬레이션)
        ======================== -->
        <div id="signup-page" class="page bg-white p-8 rounded-xl shadow-2xl">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">회원가입 (시뮬레이션)</h2>
            <div id="signup-error" class="text-red-500 text-center mb-4 hidden text-sm font-semibold"></div>
            <form id="signup-form">
                <div class="mb-4">
                    <label for="signup-email" class="block text-sm font-medium text-gray-700 mb-2">아이디 (이메일)</label>
                    <input type="email" id="signup-email" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="user@example.com" autocomplete="email" required>
                </div>
                <div class="mb-6">
                    <label for="signup-password" class="block text-sm font-medium text-gray-700 mb-2">비밀번호</label>
                    <input type="password" id="signup-password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="6자리 이상" autocomplete="new-password" required>
                </div>
                <button type="submit" id="signup-btn" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-300">
                    회원가입
                </button>
                <button type="button" id="nav-to-login" class="w-full text-sm text-center text-blue-600 hover:underline mt-4">
                    이미 계정이 있으신가요? 로그인
                </button>
            </form>
        </div>

        <!-- =======================
             2. 메인 메뉴 페이지
        ======================== -->
        <div id="main-menu-page" class="page bg-white p-8 rounded-xl shadow-2xl">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">무엇을 도와드릴까요?</h2>
            <p id="welcome-user" class="text-center text-gray-600 mb-10 text-sm break-all">사용자 정보 로딩 중...</p>
            <div class="flex flex-col space-y-4">
                <button id="nav-summary" class="text-left p-6 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 flex items-center space-x-4">
                    <svg class="w-8 h-8 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                    <div>
                        <span class="text-lg font-semibold">학습내용 정리 요약</span>
                        <span class="block text-sm text-indigo-100">텍스트와 이미지로 학습 내용을 요약합니다.</span>
                    </div>
                </button>
                
                <button id="nav-counseling" class="text-left p-6 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition duration-300 flex items-center space-x-4">
                     <svg class="w-8 h-8 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2V10a2 2 0 012-2h8zM7 8H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l4-4h2"></path></svg>
                    <div>
                        <span class="text-lg font-semibold">AI 진로 상담 시스템</span>
                        <span class="block text-sm text-green-100">전문 AI가 진로 고민을 상담해 드립니다.</span>
                    </div>
                </button>
            </div>
            
            <button id="logout-btn" class="w-full text-sm text-gray-500 hover:text-red-600 hover:underline mt-8 transition">로그아웃</button>
        </div>

        <!-- =======================
             3. 학습 요약 페이지
        ======================== -->
        <div id="summary-page" class="page bg-white p-8 rounded-xl shadow-2xl">
            <button class="back-to-main text-blue-600 hover:underline mb-4 inline-block">&larr; 뒤로가기</button>
            <h2 class="text-3xl font-bold text-gray-800 mb-6">학습내용 정리 요약</h2>
            
            <div class="mb-4">
                <label for="summary-text" class="block text-sm font-medium text-gray-700 mb-2">요약할 내용을 입력하세요:</label>
                <div class="flex flex-col md:flex-row gap-4">
                    <textarea id="summary-text" rows="8" class="flex-grow w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="요약하고 싶은 텍스트를 여기에 붙여넣으세요..."></textarea>
                    <!-- 예시 상자 삭제됨 -->
                </div>
            </div>

            <div class="flex items-center space-x-3 mb-6">
                <button id="summarize-text-btn" class="flex-1 bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                    텍스트 요약하기
                </button>
                <button id="camera-btn" class="flex-1 bg-gray-700 text-white p-3 rounded-lg font-semibold hover:bg-gray-800 transition flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span>카메라로 찍기</span>
                </button>
            </div>
            
            <!-- 이미지 업로드를 위한 숨겨진 input -->
            <input type="file" id="image-upload" accept="image/*" class="hidden">
            <p id="image-upload-status" class="text-sm text-gray-500 mb-4 hidden"></p>

            <!-- 요약 결과 표시 영역 -->
            <div class="mt-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">요약 결과:</h3>
                <div id="summary-output" class="p-4 bg-gray-50 rounded-lg border border-gray-200 min-h-[100px] text-gray-600">
                    요약 결과가 여기에 표시됩니다.
                </div>
            </div>
        </div>

        <!-- =======================
             4. AI 진로 상담 페이지
        ======================== -->
        <div id="counseling-page" class="page bg-white p-8 rounded-xl shadow-2xl">
            <button class="back-to-main text-blue-600 hover:underline mb-4 inline-block">&larr; 뒤로가기</button>
            <h2 class="text-3xl font-bold text-gray-800 mb-2">AI 진로 상담 시스템</h2>
            <p class="text-gray-600 mb-6">무엇이든 자유롭게 이야기해주세요. AI 상담사가 함께 고민해 드립니다.</p>

            <!-- 채팅창 -->
            <div id="chat-window" class="h-96 border border-gray-300 rounded-lg p-4 overflow-y-auto bg-white mb-4 flex flex-col space-y-2">
                <!-- 채팅 메시지가 여기에 동적으로 추가됩니다 -->
            </div>

            <!-- 메시지 입력란 -->
            <form id="chat-form" class="flex space-x-2">
                <input type="text" id="chat-input" class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="메시지를 입력하세요...">
                <button type="submit" id="send-chat-btn" class="bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition w-16 flex items-center justify-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                </button>
            </form>
        </div>

    </div>

    <!-- =======================
         자바스크립트 로직
    ======================== -->
    <script type="module">
        // Firebase 모듈 임포트
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInAnonymously,
            signInWithCustomToken // 익명 로그인이나 커스텀 토큰 로그인만 사용
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestore 로깅 활성화 (디버깅 목적)
        setLogLevel('Debug');

        // --- 전역 변수 ---
        let currentUserId = null;
        let currentUserName = null; // 시뮬레이션된 로그인 사용자 이름 (이메일)
        let counselingHistory = []; // 현재 대화 내역
        let chatHistoryLoaded = false; // 중복 로드 방지
        const USER_KEY = 'ai_helper_simulated_user'; // localStorage 키: 시뮬레이션된 사용자 정보를 저장하는 키

        // --- (리얼) Gemini API 호출 관련 ---
        const apiKey = "AIzaSyAsO4FSthGy-fmS6bVha5w9cBzKJQ1IFmg"; // API 키 (보안상 비워둠 - 캔버스 환경에서 자동 제공)

        // --- Firebase (리얼) ---
        // 캔버스 환경에서 제공하는 전역 변수를 사용
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{"apiKey": "demo", "authDomain": "demo.firebaseapp.com", "projectId": "demo"}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, auth, db;

        // --- 페이지 네비게이션 ---
        function showPage(pageId) {
            // 모든 페이지 숨기기
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            
            // 요청된 페이지만 표시하기
            const activePage = document.getElementById(pageId);
            if (activePage) {
                activePage.style.display = 'block';
            }
        }

        // --- 시뮬레이션 로그인 상태 관리 함수 ---

        /**
         * 시뮬레이션 로그인 상태를 설정하고 Firebase 익명 로그인 실행하여 고유 UID를 획득합니다.
         * @param {string} username - 시뮬레이션된 사용자 이름 (이메일)
         */
        async function setLoggedInUser(username) {
            currentUserName = username;
            
            try {
                // __initial_auth_token이 정의되어 있으면 커스텀 토큰으로 로그인 시도
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // 그렇지 않으면 익명 로그인 시도
                    await signInAnonymously(auth); 
                }
                // onAuthStateChanged가 나머지를 처리합니다.
            } catch (error) {
                console.error("Firebase 인증 실패:", error);
                document.getElementById('welcome-user').textContent = `[경고] ${username}님, 인증에 실패했습니다. 기능 사용에 제한이 있을 수 있습니다.`;
                showPage('main-menu-page');
            }
        }

        // 로그아웃 (시뮬레이션 상태 및 Firebase 상태 초기화)
        async function logoutUser() {
            currentUserName = null;
            currentUserId = null;
            localStorage.removeItem('lastLoggedInUser'); // 마지막 로그인 정보 제거
            try {
                // Firebase 로그아웃
                await auth.signOut();
            } catch (e) {
                console.error("Firebase Sign Out Error:", e);
            }
            showPage('login-page');
        }

        // --- DOM 로드 후 실행 ---
        document.addEventListener('DOMContentLoaded', () => {

            // Firebase 초기화
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (error) {
                console.error("Firebase 초기화 실패:", error);
                document.getElementById('welcome-user').textContent = "시스템 초기화에 실패했습니다. 새로고침해주세요.";
                return;
            }

            // --- 0. 인증 상태 리스너 ---
            onAuthStateChanged(auth, (user) => {
                // 이 리스너는 setLoggedInUser 후에 실행되어 UID를 최종 설정합니다.
                if (user && currentUserName) { 
                    // 사용자가 Firebase에 로그인됨
                    currentUserId = user.uid;
                    // 사용자 ID의 앞 8자리만 표시 (규칙 준수)
                    document.getElementById('welcome-user').textContent = `${currentUserName}님, 환영합니다. (ID: ${currentUserId})`;
                    showPage('main-menu-page');
                } else if (!user && !currentUserName) {
                    // 로그아웃 상태이거나 앱 시작 시
                    currentUserId = null;
                    counselingHistory = []; 
                    chatHistoryLoaded = false; 
                    document.getElementById('chat-window').innerHTML = ''; 
                    showPage('login-page');
                }
            });


            // --- 1. 회원가입/로그인 시뮬레이션 로직 ---
            
            // 시뮬레이션 사용자 데이터 로드 (localStorage 사용)
            const simulatedUsers = JSON.parse(localStorage.getItem(USER_KEY) || '{}');

            // 1.1 회원가입 로직
            const signupForm = document.getElementById('signup-form');
            const signupError = document.getElementById('signup-error');

            signupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('signup-email').value.trim();
                const password = document.getElementById('signup-password').value;
                signupError.classList.add('hidden');

                if (password.length < 6) {
                    signupError.textContent = '비밀번호는 6자리 이상이어야 합니다.';
                    signupError.classList.remove('hidden');
                    return;
                }
                if (simulatedUsers[email]) {
                    signupError.textContent = '이미 등록된 이메일입니다.';
                    signupError.classList.remove('hidden');
                    return;
                }

                // 시뮬레이션 등록 및 저장
                simulatedUsers[email] = password;
                localStorage.setItem(USER_KEY, JSON.stringify(simulatedUsers));
                
                // 사용자 정의 alert 대신 DOM 조작을 통해 메시지 표시
                signupError.textContent = '회원가입이 성공적으로 완료되었습니다! 로그인 페이지로 이동합니다.';
                signupError.classList.remove('hidden');
                
                setTimeout(() => {
                    document.getElementById('signup-email').value = '';
                    document.getElementById('signup-password').value = '';
                    signupError.classList.add('hidden');
                    showPage('login-page');
                }, 1500);
            });

            // 1.2 로그인 로직
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                loginError.classList.add('hidden');

                if (simulatedUsers[email] && simulatedUsers[email] === password) {
                    // 시뮬레이션 로그인 성공 -> Firebase 익명 로그인 실행 (UID 획득)
                    // 로그인 성공 시 마지막 로그인 사용자 저장
                    localStorage.setItem('lastLoggedInUser', email);
                    await setLoggedInUser(email);
                    // onAuthStateChanged가 메인 메뉴로 이동시킵니다.
                } else {
                    loginError.textContent = '아이디 또는 비밀번호가 올바르지 않습니다.';
                    loginError.classList.remove('hidden');
                }
            });

            // 1.3 페이지 전환 버튼
            document.getElementById('nav-to-signup').addEventListener('click', () => {
                loginError.classList.add('hidden');
                document.getElementById('signup-email').value = '';
                document.getElementById('signup-password').value = '';
                signupError.classList.add('hidden');
                showPage('signup-page');
            });
            document.getElementById('nav-to-login').addEventListener('click', () => {
                signupError.classList.add('hidden');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                loginError.classList.add('hidden');
                showPage('login-page');
            });
            
            // 2. 메인 메뉴 페이지 로직
            document.getElementById('nav-summary').addEventListener('click', () => {
                showPage('summary-page');
            });

            document.getElementById('nav-counseling').addEventListener('click', () => {
                showPage('counseling-page');
                startCounseling(); // 상담 시작 함수 호출
            });
            
            // 2.1 로그아웃 버튼 (시뮬레이션)
            document.getElementById('logout-btn').addEventListener('click', async () => {
                await logoutUser();
            });

            // --- 3. 공통: 뒤로가기 버튼 ---
            document.querySelectorAll('.back-to-main').forEach(button => {
                button.addEventListener('click', () => {
                    showPage('main-menu-page');
                });
            });

            // --- 4. 학습 요약 페이지 로직 ---
            const summarizeTextBtn = document.getElementById('summarize-text-btn');
            const summaryOutput = document.getElementById('summary-output');
            const summaryText = document.getElementById('summary-text');
            
            summarizeTextBtn.addEventListener('click', async () => {
                const text = summaryText.value;
                if (!text.trim()) {
                    summaryOutput.textContent = '요약할 텍스트를 입력해주세요.';
                    return;
                }
                summaryOutput.textContent = 'AI가 텍스트를 요약하는 중입니다...';
                
                // (리얼) Gemini API 호출
                const systemInstruction = "You are a helpful assistant who summarizes study materials. Provide the summary in Korean. Summarize the key points neatly, using bullet points (e.g., '- [point]') and keeping the total summary concise.";
                const userPrompt = `다음 텍스트를 핵심 내용만 간추려 요약해줘: "${text}"`;
                
                try {
                    const summary = await callGeminiAPI(userPrompt, systemInstruction);
                    summaryOutput.textContent = summary;
                } catch (error) {
                    console.error("Error summarizing text:", error);
                    summaryOutput.textContent = '텍스트 요약 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.';
                }
            });
            
            // 카메라 버튼 로직
            const cameraBtn = document.getElementById('camera-btn');
            const imageUpload = document.getElementById('image-upload');
            const imageUploadStatus = document.getElementById('image-upload-status');
            
            cameraBtn.addEventListener('click', () => {
                imageUpload.click(); // 숨겨진 file input 클릭
            });
            
            imageUpload.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (file) {
                    imageUploadStatus.textContent = `'${file.name}' 이미지를 분석 중입니다...`;
                    imageUploadStatus.classList.remove('hidden');
                    summaryOutput.textContent = 'AI가 이미지를 분석하고 요약하는 중입니다...';
                    
                    try {
                        // 1. 이미지를 Base64로 변환
                        const base64ImageData = await fileToBase64(file);
                        const mimeType = file.type;

                        // 2. (리얼) Gemini API (이미지) 호출
                        const systemInstruction = "You are a helpful assistant who analyzes images (like textbook pages) and summarizes the text content. Provide the summary in Korean. Summarize the key points neatly, using bullet points (e.g., '- [point]') and keeping the total summary concise.";
                        const userPrompt = "이 이미지에 있는 텍스트를 읽고 핵심 내용을 요약해줘.";
                        
                        const summary = await callGeminiAPI(userPrompt, systemInstruction, [{
                            inlineData: {
                                data: base64ImageData,
                                mimeType: mimeType
                            }
                        }]);
                        
                        summaryOutput.textContent = summary;
                        imageUploadStatus.textContent = `'${file.name}' 이미지 요약이 완료되었습니다.`;
                        
                    } catch (error) {
                        console.error("Error summarizing image:", error);
                        summaryOutput.textContent = '이미지 요약 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.';
                        imageUploadStatus.textContent = '이미지 분석에 실패했습니다.';
                    } finally {
                        // 파일 입력 초기화
                        event.target.value = '';
                    }
                }
            });

            // --- 5. AI 진로 상담 페이지 로직 ---
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            
            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const message = chatInput.value;
                if (!message.trim()) return;
                
                addChatMessage(message, 'user');
                chatInput.value = '';
                
                // AI 응답 로직
                const thinkingBubble = addChatMessage('AI 상담사가 생각 중입니다...', 'ai-thinking');
                
                const response = await getAIChatResponse(message);
                
                // '생각 중' 메시지 제거
                thinkingBubble.remove();
                addChatMessage(response, 'ai');
            });

            // --- 앱 시작 시 로직 ---
            // 마지막 로그인 이메일을 확인하고, 있으면 자동 로그인 시뮬레이션 시도
            const lastLoggedInEmail = localStorage.getItem('lastLoggedInUser');
            if (lastLoggedInEmail) {
                // 시뮬레이션 상태 설정 후 Firebase 익명 로그인 시도
                setLoggedInUser(lastLoggedInEmail); 
                // onAuthStateChanged가 나머지 처리를 합니다.
            } else {
                // 저장된 정보가 없으면 로그인 페이지 표시
                showPage('login-page');
            }
        });
        
        // --- 상담 관련 함수 ---
        
        async function startCounseling() {
            // 이미 로드했거나, 시뮬레이션 로그인 정보가 없다면 실행 중지
            if (chatHistoryLoaded || !currentUserName) return;

            chatHistoryLoaded = true; // 로드 시작
            await loadChatHistory(); // Firestore에서 내역 불러오기
        }
        
        // (신규) 채팅 내역 화면에 렌더링
        function renderChatHistory() {
            const chatWindow = document.getElementById('chat-window');
            chatWindow.innerHTML = ''; // 채팅창 비우기
            counselingHistory.forEach(message => {
                // parts[0].text가 없는 경우 (오래된 데이터) 스킵
                if (message.parts && message.parts[0] && message.parts[0].text) {
                     // 롤에 따라 sender를 설정. model은 'ai'로 간주
                     addChatMessage(message.parts[0].text, message.role === 'user' ? 'user' : 'ai');
                }
            });
        }
        
        // (신규) Firestore에서 채팅 내역 불러오기
        async function loadChatHistory() {
            if (!currentUserName) return; // 시뮬레이션 사용자 이름이 없으면 저장 불가
            
            // 사용자 이름(이메일)을 키로 사용하여 Firestore 문서 경로 생성
            // 특수문자를 언더바로 치환하여 Firestore 경로 안전성 확보
            const safeUserName = currentUserName.replace(/[^a-zA-Z0-9]/g, '_');
            // 'artifacts/{appId}/public/data/chat_history/{safeUserName}' 경로 사용
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'chat_history', safeUserName);

            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    counselingHistory = docSnap.data().history || [];
                } else {
                    // 새 사용자를 위한 환영 메시지
                    counselingHistory = [
                        {
                            role: "model",
                            parts: [{ text: "안녕하세요! 저는 AI 진로 상담사입니다. 어떤 고민이 있으신가요? 편하게 말씀해주세요." }]
                        }
                    ];
                }
            } catch (error) {
                console.error("대화 내역 로드 실패:", error);
                counselingHistory = [
                    {
                        role: "model",
                        parts: [{ text: "대화 내역을 불러오는 데 실패했습니다. 새 대화를 시작합니다." }]
                    }
                ];
            }
            renderChatHistory(); // 화면에 렌더링
        }
        
        // (신규) Firestore에 채팅 내역 저장하기
        async function saveChatHistory() {
            if (!currentUserName) return;
            
            const safeUserName = currentUserName.replace(/[^a-zA-Z0-9]/g, '_');
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'chat_history', safeUserName);

            try {
                // counselingHistory 전체를 'history' 필드에 저장
                // Firestore는 이 배열을 자동으로 직렬화할 수 있습니다.
                await setDoc(docRef, { history: counselingHistory });
            } catch (error) {
                console.error("대화 내역 저장 실패:", error);
                // 사용자에게 알림 (옵션) - 이 알림은 디버깅에 유용합니다.
                addChatMessage("[시스템: 대화가 저장되지 않았습니다. 인터넷 연결 또는 인증 상태를 확인해주세요.]", 'ai-thinking');
            }
        }
        
        function addChatMessage(message, sender) {
            const chatWindow = document.getElementById('chat-window');
            const bubble = document.createElement('div');
            bubble.classList.add('chat-bubble');
            
            if (sender === 'user') {
                bubble.classList.add('user-bubble');
            } else if (sender === 'ai') {
                bubble.classList.add('ai-bubble');
            } else if (sender === 'ai-thinking') {
                bubble.classList.add('ai-thinking-bubble');
            }
            
            // HTML 태그가 있다면 텍스트로만 표시되도록 처리
            bubble.textContent = message;
            chatWindow.appendChild(bubble);
            
            // 스크롤을 맨 아래로 이동
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return bubble; // '생각 중' 버블을 제어하기 위해 반환
        }

        async function getAIChatResponse(userMessage) {
            // 사용자 메시지를 상담 내역에 추가
            const newUserMessage = {
                role: "user",
                parts: [{ text: userMessage }]
            };
            counselingHistory.push(newUserMessage);
            
            // (리얼) Gemini API 호출
            const systemMessage = "당신은 전문적이고 공감 능력이 뛰어난 10대 전문 AI 진로 상담사입니다. 사용자의 고민을 깊이 공감하며, 긍정적이고 구체적이며 현실적인 조언을 제공해야 합니다. 항상 친절하고 전문적인 한국어 어조를 유지하세요. 10대에게 맞춰 이해하기 쉬운 용어를 사용해주세요. 답변은 5~7줄, 최대 10줄을 넘지 않도록 간결하게 작성해주세요.";
            
            try {
                // 전체 counselingHistory를 전달 (대화 맥락 유지)
                const aiResponse = await callGeminiAPI(counselingHistory, systemMessage);
                
                // AI 응답을 상담 내역에 추가
                counselingHistory.push({
                    role: "model",
                    parts: [{ text: aiResponse }]
                });
                
                // (저장) 대화가 끝난 후 Firestore에 저장
                await saveChatHistory();
                
                return aiResponse;
            } catch (error) {
                console.error("Error in AI chat response:", error);
                // 실패 시, 히스토리에서 마지막 user-message 롤백
                // (API 호출 전에 추가된 메시지를 제거)
                if (counselingHistory[counselingHistory.length - 1] === newUserMessage) {
                    counselingHistory.pop();
                }
                return "죄송합니다. 지금은 답변을 드릴 수 없습니다. 잠시 후 다시 시도해주세요. (오류: " + error.message + ")";
            }
        }

        /**
         * 이미지를 Base64 문자열로 변환합니다.
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    // "data:image/jpeg;base64," 부분을 제거
                    resolve(reader.result.split(',')[1]);
                };
                reader.onerror = error => reject(error);
            });
        }

        /**
         * Gemini API를 호출하는 공통 함수 (Exponential Backoff 포함)
         * @param {string|Array} prompt - 사용자 프롬프트 (문자열) 또는 채팅 내역 (배열)
         * @param {string} systemInstruction - 시스템 메시지
         * @param {Array} imageParts - (선택) 이미지 데이터 파트
         * @param {number} maxRetries - 최대 재시도 횟수
         */
        async function callGeminiAPI(prompt, systemInstruction, imageParts = null, maxRetries = 3) {
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            let payload = {
                contents: [],
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                }
            };

            // 프롬프트 타입에 따라 payload 구성
            if (Array.isArray(prompt)) {
                // 채팅 내역 (상담용)
                payload.contents = prompt;
            } else if (typeof prompt === 'string') {
                // 단순 텍스트 또는 텍스트+이미지 (요약용)
                const userParts = [{ text: prompt }];
                if (imageParts) {
                    userParts.push(...imageParts);
                }
                payload.contents = [{ role: "user", parts: userParts }];
            }

            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        // 429 (Too Many Requests) 같은 경우 재시도
                        if (response.status === 429) {
                            throw new Error(`API call failed with status: ${response.status} (Rate Limit)`);
                        }
                        // 그 외 에러는 즉시 중단
                        console.error("API Error Body:", errorBody);
                        throw new Error(`API call failed with status: ${response.status} - ${errorBody.error?.message || 'Unknown Error'}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0].content?.parts?.[0]?.text) {
                        return result.candidates[0].content.parts[0].text;
                    } else if (result.candidates && result.candidates[0].finishReason) {
                        // 콘텐츠 없이 'STOP' 외 다른 이유로 종료된 경우 (e.g., SAFETY)
                        const reason = result.candidates[0].finishReason;
                        console.warn("API call finished with reason:", reason);
                        throw new Error(`Content generation stopped unexpectedly (Reason: ${reason}).`);
                    } else {
                        // 응답은 왔지만 내용이 비어있는 경우
                        throw new Error("API returned an empty or malformed content structure.");
                    }
                
                } catch (error) {
                    // network error, parsing error, or explicit throw
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    attempt++;
                    if (attempt >= maxRetries) {
                        throw error; // 최대 재시도 횟수 도달 시 에러 발생
                    }
                    // Exponential backoff: 1s, 2s, 4s, ...
                    const delay = Math.pow(2, attempt) * 1000; 
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            // 이 부분은 도달하지 않아야 함
            throw new Error("AI API call failed after all retries.");
        }

    </script>
</body>
</html>